from pydantic import BaseModel, EmailStr, Field, validator
from typing import Optional
from datetime import date, datetime
from app.schemas.area import AreaResponse
from uuid import UUID

class EmployeeBase(BaseModel):
    """Schema base para colaborador"""
    nome: str = Field(..., min_length=3, max_length=200)
    email: EmailStr
    cargo: str = Field(..., min_length=2, max_length=100)
    cpf: Optional[str] = Field(None, min_length=11, max_length=14)
    data_nascimento: Optional[date] = None
    telefone: Optional[str] = None
    data_admissao: Optional[date] = None
    salario: Optional[float] = None
    status: Optional[str] = Field(default="ATIVO")
    area_id: Optional[UUID] = None  # üîó Relacionamento com Area

    @validator("cpf")
    def validar_cpf(cls, v):
        """Valida o CPF (b√°sico)"""
        if v:
            cpf = ''.join(filter(str.isdigit, v))
            if len(cpf) != 11:
                raise ValueError("CPF deve ter 11 d√≠gitos num√©ricos")
            return cpf
        return v

    class Config:
        from_attributes = True


class EmployeeCreate(EmployeeBase):
    """Schema para cria√ß√£o de colaborador"""
    pass


class EmployeeUpdate(BaseModel):
    """Schema para atualiza√ß√£o parcial"""
    nome: Optional[str] = None
    email: Optional[EmailStr] = None
    cargo: Optional[str] = None
    telefone: Optional[str] = None
    salario: Optional[float] = None
    status: Optional[str] = None
    area_id: Optional[UUID] = None

    class Config:
        from_attributes = True


class EmployeeResponse(BaseModel):
    """Schema de resposta simplificada"""
    id: UUID
    nome: str
    email: EmailStr
    cargo: str
    cpf: Optional[str] = None
    telefone: Optional[str] = None
    salario: Optional[float] = None
    status: str
    data_admissao: Optional[date] = None
    area: Optional[AreaResponse] = None
    created_at: Optional[datetime] = None
    updated_at: Optional[datetime] = None

    class Config:
        orm_mode = True
        from_attributes = True


class EmployeeListResponse(EmployeeResponse):
    """Schema para listagem de colaboradores"""
    pass


class EmployeeDetailResponse(EmployeeResponse):
    """Schema detalhado com campos extras"""
    data_nascimento: Optional[date] = None
    observacoes: Optional[str] = None
    senioridade: Optional[str] = None
    filhos_qtd: Optional[int] = None

    class Config:
        from_attributes = True


class EmployeePDI(BaseModel):
    """Schema para PDI"""
    objetivo: str
    descricao: Optional[str] = None
    data_limite: date
    status: str = "EM_ANDAMENTO"

    class Config:
        from_attributes = True


class EmployeeVacation(BaseModel):
    """Schema para f√©rias"""
    inicio: date
    fim: date
    dias: int
    status: str = "PENDENTE"

    @validator("fim")
    def validate_dates(cls, v, values):
        if "inicio" in values and v <= values["inicio"]:
            raise ValueError("Data final deve ser posterior √† inicial")
        return v

    class Config:
        from_attributes = True


class EmployeeStats(BaseModel):
    """Schema de estat√≠sticas"""
    total: int
    ativos: int
    ferias: int
    afastados: int
    desligados: int
    timestamp: datetime

    class Config:
        from_attributes = True
